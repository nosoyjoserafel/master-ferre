<!DOCTYPE html>
    <html>
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Usuarios</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
        </head>
        <style>
            #overlay {
                position: fixed;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .form-container {
                background: white;
                padding: 20px;
                border-radius: 5px;
            }
        </style>
        <body>
            <form id="buscar-usuario-form">
                <label for="cedula">Cédula:</label><br>
                <input type="number" id="cedula" name="cedula"><br>      
                <input type="button" id="buscar" value="Buscar"><br>
                <input type="button" id="modificar" value="Modificar"><br>
                <input type="button" id="eliminar" value="Eliminar"> 
                <br>
                <br>
                <a href="/main" id="regresar-inicio">Regresar al inicio</a>
            </form>
            <div id="overlay">
                <form>
                    <div class="form-container">
                        <h2>Modificar usuario</h2>
                        <label for="cedula">Cedula: <input type="text" name="cedula" id="cedula" readonly></label><br>
                        <label for="nombreModificado">Nombre: <input type="text" name="nombre" id="nombreModificado"></label><br>
                        <label for="apellidoModificado">Apellido: <input type="text" name="apellido" id="apellidoModificado"></label><br>
                        <label for="emailModificado">Email: <input type="text" name="email" id="emailModificado"></label><br>
                        <label for="nombreUsuarioModificado">Nombre de usuario: <input type="text" name="nombreUsuario" id="nombreUsuarioModificado"></label><br>
                        <label for="contraseñaModificada">Contraseña: <input type="text" name="contraseña" id="contraseñaModificada"></label><br>
                        <label for="telefonoModificado">Telefono: <input type="number" name="telefono" id="telefonoModificado"></label><br>
                        <label for="direccionModificada">Direccion: <input type="text" name="direccion" id="direccionModificada"></label><br>
                        <button type="button" id="saveChanges">Guardar</button>
                        <button type="button" id="closeOverlay">X</button>
                    </div>
                </form>
            </div>

            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
            <script>
                function mostrarDatosUsuario(usuario) {
                    var contenedor = document.getElementById('usuario-info');
                    
                    if (!contenedor) {
                        contenedor = document.createElement('div');
                        contenedor.id = 'usuario-info';                    
                        var referencia = document.getElementById('regresar-inicio');
                        referencia.parentNode.insertBefore(contenedor, referencia);
                    } else {
                        contenedor.innerHTML = '';
                    }
                    
                    var nombreElemento = document.getElementById('usuario-nombre');
                    if (!nombreElemento) {
                        nombreElemento = document.createElement('p');
                        nombreElemento.id = 'usuario-nombre';
                        contenedor.appendChild(nombreElemento);
                    }
                    nombreElemento.textContent = `Nombre: ${usuario.nombre}`;
                    
                    var apellidoElemento = document.getElementById('usuario-apellido');
                    if (!apellidoElemento) {
                        apellidoElemento = document.createElement('p');
                        apellidoElemento.id = 'usuario-apellido';
                        contenedor.appendChild(apellidoElemento);
                    }
                    apellidoElemento.textContent = `Apellido: ${usuario.apellido}`;

                    var emailElemento = document.getElementById('usuario-email');
                    if (!emailElemento) {
                        emailElemento = document.createElement('p');
                        emailElemento.id = 'usuario-email';
                        contenedor.appendChild(emailElemento);
                    }
                    emailElemento.textContent = `Email: ${usuario.email}`;

                    var nombreUsuarioElemento = document.getElementById('usuario-nombre-usuario');
                    if (!nombreUsuarioElemento) {
                        nombreUsuarioElemento = document.createElement('p');
                        nombreUsuarioElemento.id = 'usuario-nombre-usuario';
                        contenedor.appendChild(nombreUsuarioElemento);
                    }
                    nombreUsuarioElemento.textContent = `Nombre de usuario: ${usuario.usuario}`;

                    var telefonoElemento = document.getElementById('usuario-telefono');
                    if (!telefonoElemento) {
                        telefonoElemento = document.createElement('p');
                        telefonoElemento.id = 'usuario-telefono';
                        contenedor.appendChild(telefonoElemento);
                    }
                    telefonoElemento.textContent = `Telefono: ${usuario.telefono}`;

                    var direccionElemento = document.getElementById('usuario-direccion');
                    if (!direccionElemento) {
                        direccionElemento = document.createElement('p');
                        direccionElemento.id = 'usuario-direccion';
                        contenedor.appendChild(direccionElemento);
                    }
                    direccionElemento.textContent = `Direccion: ${usuario.direccion}`;
                }                

                window.onload = function() {
                    document.getElementById("overlay").style.display = "none";
                };

                function mostrarDatosAModificar(usuario) {
                    document.getElementById("overlay").style.display = "block";
                    document.querySelector("#overlay #cedula").value = usuario.cedula;
                    document.querySelector("#overlay #nombreModificado").value = usuario.nombre;
                    document.querySelector("#overlay #apellidoModificado").value = usuario.apellido;
                    document.querySelector("#overlay #emailModificado").value = usuario.email;
                    document.querySelector("#overlay #nombreUsuarioModificado").value = usuario.usuario;
                    document.querySelector("#overlay #contraseñaModificada").value = usuario.contrasenia;
                    document.querySelector("#overlay #telefonoModificado").value = usuario.telefono;
                    document.querySelector("#overlay #direccionModificada").value = usuario.direccion;
                }

                window.onclick = function(event) {
                    var modal = document.getElementById("overlay");
                    if (event.target == modal) {
                        modal.style.display = "none";
                    }
                };

                document.querySelector("#closeOverlay").addEventListener("click", function() {
                    document.getElementById("overlay").style.display = "none";
                });

                document.getElementById('saveChanges').addEventListener('click', function() {
                    const updatedUser = {
                        cedula: document.querySelector('#overlay #cedula').value,
                        nombre: document.querySelector('#overlay #nombreModificado').value,
                        apellido: document.querySelector('#overlay #apellidoModificado').value,
                        email: document.querySelector('#overlay #emailModificado').value,
                        usuario: document.querySelector('#overlay #nombreUsuarioModificado').value,
                        contrasenia: document.querySelector('#overlay #contraseñaModificada').value,
                        telefono: document.querySelector('#overlay #telefonoModificado').value,
                        direccion: document.querySelector('#overlay #direccionModificada').value
                    };

                    // Enviar los datos actualizados al servidor
                    fetch(`/buscar-usuario`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updatedUser),
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error al actualizar el producto en el catálogo');
                        }                 
                        alert('Datos del usuario actualizados correctamente');
                        window.location.reload();
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
                });

                $("#buscar").click(function(e) {
                    e.preventDefault();

                    var cedula = $("#cedula").val();

                    $.ajax({
                        type: "GET",
                        url: `http://localhost:3000/buscar-usuario?cedula=${cedula}`,
                        contentType: "application/json"                            
                    }).done(function(usuario) {
                        if(usuario!==null)
                            mostrarDatosUsuario(usuario);
                    }).fail(function(jqXHR, textStatus) {
                        alert("Request failed: " + textStatus);
                    });
                });

                $("#modificar").click(function(e) {
                    e.preventDefault();

                    var cedula = $("#cedula").val();

                    $.ajax({
                        type: "GET",
                        url: `http://localhost:3000/buscar-usuario?cedula=${cedula}`,
                        contentType: "application/json"                            
                    }).done(function(usuario) {
                        if(usuario!==null)
                            mostrarDatosAModificar(usuario);
                    }).fail(function(jqXHR, textStatus) {
                        alert("Request failed: " + textStatus);
                    });
                });

                $("#eliminar").click(function(e) {
                    e.preventDefault();

                    var cedula = $("#cedula").val();

                    $.ajax({
                        type: "DELETE",
                        url: `http://localhost:3000/buscar-usuario?cedula=${cedula}`,
                        contentType: "application/json"                            
                    }).done(function() {
                        alert("Usuario eliminado");
                        if(document.getElementById('usuario-info')){
                            document.getElementById('usuario-info').remove();
                        
                        }
                    }).fail(function(jqXHR, textStatus) {
                        alert("Request failed: " + textStatus);
                    });
                });
            </script>
        </body>
    </html>